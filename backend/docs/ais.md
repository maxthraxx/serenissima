# La Serenissima AI System

This document explains the AI system in La Serenissima, which allows non-player characters to participate in the game economy and create a more dynamic marketplace.

## Overview

The AI system consists of automated agents that simulate the behavior of Venetian merchants, nobles, and other economic actors. These AI citizens can participate in various economic activities such as bidding on lands, managing properties, and engaging in commerce.

AI citizens are marked in the database with an `IsAI` flag, but they share the same underlying citizen model as human players. This means AI citizens and human players exist in the same world, follow the same rules, and can interact with each other.

### Unified Citizen Model

Both AI and human citizens:
- Appear on the map and move around Venice
- Own lands, buildings, and businesses
- Work, pay rent, and participate in the economy
- Generate and spend income
- Follow the same economic rules and constraints
- Can communicate with each other through the messaging system

The key difference is that AI citizens have their economic decisions automated through scripts, while human players make decisions manually. This automation makes AI citizens "alive" in the game world, creating a dynamic economy even in areas with limited player activity.

## AI Behaviors

### Message Responses (Uses KinOS Engine API)

**Implementation**: `backend/ais/answertomessages.py`  
**Schedule**: 10 times daily (every 2.4 hours)

AI citizens actively respond to messages they receive from human players:

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it checks for unread messages addressed to them
3. For each unread message, the AI:
   - Marks the message as read
   - Generates a contextually appropriate response using the KinOS Engine API
   - Creates a new message record with the AI's response to the sender

4. The system tracks response statistics and creates an admin notification summarizing the number of responses generated by each AI

#### Impact:

The AI message response system:
- Creates a more interactive and responsive game world
- Allows players to communicate with AI characters and receive meaningful responses
- Simulates a living community of Venetian citizens and merchants
- Provides opportunities for roleplaying and storytelling
- Enhances immersion by making AI characters feel more alive and responsive

#### Potential Extension to Player Citizens:

Consideration is being given to the possibility of extending an autonomous response mechanism, via the KinOS Engine API, to human-controlled citizens when they are offline.
-   **Objective:** To allow continuity of interactions and business, making the player's citizen less passive in their absence.
-   **Envisioned Operation:** The player could define directives, limits, or a level of autonomy for their citizen. The AI would then use the citizen's personality (`CorePersonality`) and these directives to formulate responses.
-   **Advantages:** More dynamic world, possible progression of negotiations/relationships in the player's absence, increased immersion.
-   **Challenges:** Potential loss of player control, risk of AI decisions not aligned with player intentions, complexity of configuring directives by the player.
-   **Integration:** If implemented, the `answertomessages.py` script could be adapted to handle these cases, or a parallel system could be developed, ensuring a clear distinction between fully AI responses and those "delegated" for a player. Clear notifications to the player upon their return about actions taken would be crucial.

### Notification Processing (Uses KinOS Engine API)

**Implementation**: `backend/ais/processnotifications.py`  
**Schedule**: Daily at 10:00 PM UTC

AI citizens process notifications to stay informed about events in the game:

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it checks for unread notifications addressed to them
3. For each AI with unread notifications:
   - Formats all notifications into a readable message
   - Sends the notifications to the KinOS Engine API using the build endpoint
   - Marks all notifications as read after successful processing

4. The system tracks notification statistics and creates an admin notification summarizing the number of notifications processed by each AI

#### Impact:

The AI notification processing system:
- Keeps AI characters informed about game events
- Allows AI to update their understanding of the game world
- Enables more contextually aware responses in future interactions
- Creates a more coherent AI experience as characters respond to events
- Simulates AI characters actively participating in the game economy

### Business Activity and `CheckedAt` Updates for AI Operators

AI citizens who operate businesses (`RunBy`) maintain their business's productivity through their simulated daily activities.

#### Process:

1.  When an AI citizen, as a `RunBy`, engages in routine operational activities at their managed business (such as arriving via a `goto_work` activity, initiating a `production` cycle, or other relevant tasks defined by the activity system), the `CheckedAt` timestamp of that business building is automatically updated.
2.  This mechanism ensures that businesses managed by active and functioning AI citizens will typically have their `CheckedAt` timestamp refreshed regularly, thus maintaining full productivity. There isn't a separate, explicit "check-in" action; it's a byproduct of their normal simulated work.

#### Impact:

-   AI-run businesses generally operate at full productivity as their AI operators are simulated to be actively managing them.
-   This aligns with the system for human-run businesses, where the `RunBy` citizen's activity (or lack thereof) determines the `CheckedAt` status.
-   It reinforces the concept of AIs as diligent economic participants who "attend" to their responsibilities. If an AI `RunBy` fails to perform its duties (e.g., due to being stuck, lacking resources for its tasks, etc.), the `CheckedAt` might not update, leading to the productivity penalty.

### Land Bidding and Purchasing

**Bidding Implementation**: `backend/ais/bidonlands.py`  
**Schedule**: Daily at 7:00 PM UTC

**Purchasing Implementation**: `backend/ais/purchaselands.py`  
**Schedule**: Daily at 8:00 AM UTC

AI citizens actively participate in the land market by bidding on properties with income potential and purchasing available lands:

#### Bidding Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it checks:
   - Their current compute balance
   - Lands with income potential (LastIncome > 0)
   - Their existing bids on lands

3. For each land with income potential, AI citizens will:
   - Place new bids at 30 times the land's last income if they don't already have a bid
   - Increase existing bids by 14% if they already have a bid on the land

4. AI citizens only place bids if they have at least twice the bid amount in their compute balance, ensuring they maintain financial stability

5. An admin notification is created with statistics about all bidding activity, showing the number of bids placed by each AI citizen

#### Purchasing Process:

1. The script identifies all citizens marked as AI in the system, excluding ConsiglioDeiDieci
2. AI citizens are sorted by their Ducats balance in descending order
3. The script identifies all available land transactions (where Buyer is null)
4. For each AI citizen, the system:
   - Calculates their maximum spending amount (90% of their Ducats)
   - Finds the most expensive land they can afford
   - Updates the transaction with the AI as the buyer
   - Updates the land with the AI as the owner
   - Updates the AI's Ducats balance
   - Creates notifications for both the AI and administrators

5. An admin notification is created with statistics about all purchases, showing which lands were acquired by which AI citizens

#### Economic Impact:

The AI land market participation:
- Creates a dynamic land market with consistent bidding and purchasing activity
- Establishes realistic market prices based on land income potential
- Prevents land from being undervalued due to lack of player interest
- Provides competition for human players in the land market
- Ensures that valuable lands receive appropriate bids reflecting their economic value
- Allows AI citizens to build their property portfolios and participate fully in the economy

### Building Construction

**Implementation**: `backend/ais/buildbuildings.py`  
**Schedule**: Daily at 8:00 PM UTC

AI citizens actively develop lands they own by constructing buildings:

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it checks:
   - Their current compute balance
   - Lands they own
   - Existing buildings on those lands
   - Available building points on each land

3. For each land with available building points, AI citizens will:
   - Evaluate which building types can fit within the remaining points
   - Prioritize buildings with higher income potential
   - Construct buildings if they have sufficient compute (at least twice the building cost)

4. When a building is constructed:
   - The AI citizen's compute balance is reduced by the building cost
   - A transaction record is created for the building purchase
   - The land owner (if different from the AI) receives a notification

5. An admin notification is created with statistics about all building activity, showing the number of buildings constructed by each AI citizen

#### Economic Impact:

The AI building construction system:
- Encourages land development and efficient use of building points
- Creates a more dynamic and visually interesting game world
- Generates income for AI citizens through building operations
- Provides lease income to land owners (including other players)
- Reduces the Vigesima Variabilis tax rate on developed lands

### Lease Adjustments (Uses KinOS Engine API)

**Implementation**: `backend/ais/adjustleases.py`  
**Schedule**: Daily at 9:00 PM UTC

AI citizens strategically adjust lease amounts for buildings on their lands:

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it analyzes:
   - Lands they own
   - Buildings they own
   - Buildings on lands they own (potentially owned by others)
   - Current lease amounts, income, and maintenance costs

3. For each AI citizen, the system:
   - Prepares a comprehensive ledger with financial information
   - Sends this data to the KinOS Engine API for analysis
   - Receives lease adjustment decisions from the AI

4. When lease adjustments are made:
   - Building records are updated with new lease amounts
   - Building owners receive notifications about the changes
   - Reasons for adjustments are provided to maintain transparency

5. An admin notification is created with statistics about all lease adjustments, showing the changes made by each AI citizen

#### Economic Impact:

The AI lease adjustment system:
- Creates a more dynamic and responsive real estate contract
- Allows AI landowners to optimize their income from leases
- Provides contract signals about the value of different locations
- Encourages strategic building placement by players
- Simulates the economic negotiations that would occur in a real contract

### Rent Adjustments (Uses KinOS Engine API)

**Implementation**: `backend/ais/adjustrents.py`  
**Schedule**: Daily at 10:00 PM UTC

AI citizens strategically adjust rent amounts for buildings they own:

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it analyzes:
   - Buildings they own
   - Current occupants of their buildings
   - Occupant social class and wealth
   - Current rent amounts, income, and maintenance costs

3. For each AI citizen, the system:
   - Prepares a comprehensive ledger with financial information
   - Sends this data to the KinOS Engine API for analysis
   - Receives rent adjustment decisions from the AI

4. When rent adjustments are made:
   - Building records are updated with new rent amounts
   - Building occupants receive notifications about the changes
   - Reasons for adjustments are provided to maintain transparency

5. An admin notification is created with statistics about all rent adjustments, showing the changes made by each AI citizen

#### Economic Impact:

The AI rent adjustment system:
- Creates a more dynamic and responsive housing contract
- Allows AI building owners to optimize their rental income
- Provides contract signals about the value of different housing types
- Encourages citizens to seek affordable housing
- Simulates the economic negotiations that would occur in a real housing contract

### Wage Adjustments (Uses KinOS Engine API)

**Implementation**: `backend/ais/adjustwages.py`  
**Schedule**: Daily at 11:00 PM UTC

AI citizens strategically adjust wage amounts for businesses they own:

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it analyzes:
   - Businesses they own
   - Current employees of their businesses
   - Employee social class and wealth
   - Current wage amounts, business income, and expenses

3. For each AI citizen, the system:
   - Prepares a comprehensive ledger with financial information
   - Sends this data to the KinOS Engine API for analysis
   - Receives wage adjustment decisions from the AI

4. When wage adjustments are made:
   - Business records are updated with new wage amounts
   - Business employees receive notifications about the changes
   - Reasons for adjustments are provided to maintain transparency

5. An admin notification is created with statistics about all wage adjustments, showing the changes made by each AI citizen

#### Economic Impact:

The AI wage adjustment system:
- Creates a more dynamic and responsive labor contract
- Allows AI business owners to optimize their labor costs
- Provides contract signals about the value of different types of labor
- Affects citizen wealth and their ability to pay rent
- Simulates the economic negotiations that would occur in a real labor contract

### Resource Import Management (Uses KinOS Engine API)

**Implementation**: `backend/ais/adjustimports.py`  
**Schedule**: Daily at 1:00 AM UTC

AI citizens strategically set up resource imports for their buildings (via la fonction `send_import_strategy_request`):

#### Process:

1. The script identifies all citizens marked as AI in the system
2. For each AI citizen, it analyzes:
   - Buildings they own that can import resources
   - Current resource stockpiles
   - Existing import contracts
   - Available resource types and their import prices

3. For each AI citizen, the system:
   - Prepares a comprehensive ledger with resource and building information
   - Sends this data to the KinOS Engine API for analysis
   - Receives import strategy decisions from the AI

4. When import decisions are made:
   - New import contracts are created or existing ones are updated
   - Contract details include resource type, hourly amount, and price
   - Each contract is set with appropriate parameters

5. An admin notification is created with statistics about all import decisions, showing the resources being imported by each AI citizen

#### Economic Impact:

The AI resource import system:
- Ensures AI-owned buildings have necessary resources for production
- Creates a more realistic economy with active resource flows
- Allows AI citizens to participate fully in the production chain
- Simulates the international trade that was vital to Venice's economy
- Provides contract demand for various resource types

### Automated Rent Adjustments (Rule-Based)

**Implementation**: `backend/ais/automated_adjustrents.py`  
**Schedule**: Daily at 10:00 PM UTC (22:00 UTC) with `--strategy standard` (can be run with `low` or `high` manually or scheduled differently).

This script allows AI citizens to automatically adjust the `RentPrice` of buildings they own based on a specified strategy. This complements the KinOS AI-driven `adjustrents.py`.

#### Process:

1.  **Citizen Identification**: The script identifies AI citizens (`IsAI=true`, `InVenice=true`).
2.  **Building Ownership**: For each AI citizen, it retrieves all buildings they `Owner`.
3.  **Rent Calculation (`calculate_new_rent_price` function)**: For each owned building eligible for rent adjustment (typically 'home' or 'business' categories, excluding 'public_service', 'transport'):
    *   **Costs for AI Owner**:
        *   `maintenanceCost` of the building (from building type definitions).
        *   `LeasePrice` paid by the AI for the land if the AI owns the building but not the land it's on.
    *   **Market Rent Analysis**:
        *   Calculates the average `RentPrice` of similar building types in the same `District`.
    *   **Base Rent Logic**:
        *   **Home Category**: Blends a cost-plus calculation (e.g., total fixed costs \* 1.2) with the market average rent.
        *   **Business Category (RunBy != Owner)**: If the building is run by someone other than the AI owner, the rent is targeted as a share of the operator's gross profit (Building Income - Building Wages), ensuring it also covers the AI's fixed costs for the building. This is then blended with the market average rent.
        *   **Business Category (RunBy == Owner or Inn)**: If the AI runs the business themselves, or if it's an 'inn', the logic is similar to 'home' (cost-plus blended with market). Other self-run businesses might be skipped or have their rent remain unchanged.
    *   **Strategy Application**: The `--strategy` argument (`low`, `standard`, `high`) applies a multiplier (e.g., 0.9 for low, 1.0 for standard, 1.10 for high) to the base rent.
    *   **Flooring and Rounding**: The new rent is floored to at least cover fixed costs (or slightly below for 'low' strategy) and rounded to the nearest 5 Ducats.
4.  **Update and Notify**:
    *   If the calculated `new_rent` is significantly different from the `current_rent_price` (e.g., by more than 1 Ducat), the building's `RentPrice` is updated.
    *   If an `Occupant` exists, they are notified of the rent change.
    *   A summary notification of all adjustments is sent to `ConsiglioDeiDieci`.

#### Command-line Arguments:
*   `--strategy [low|standard|high]`: (Default: `standard`) Defines the pricing strategy.
    *   `low`: Aims for slightly lower rents, potentially below cost to attract tenants.
    *   `standard`: Aims for a balanced rent based on costs and market.
    *   `high`: Aims for higher rents, potentially maximizing profit.
*   `--dry-run`: Simulates the process without making changes.

#### Economic Impact:

-   Provides a baseline, rule-driven mechanism for AI landlords to manage rents.
-   Ensures rents are somewhat aligned with building costs, market conditions, and (for businesses) tenant affordability.
-   Creates more dynamic rental markets even without KinOS AI intervention for every AI.
-   The strategy parameter allows for simulating different landlord behaviors or market phases.

### Automated Wage Adjustments (Rule-Based)

**Implementation**: `backend/ais/automated_adjustwages.py`  
**Schedule**: Daily at 12:00 AM UTC (00:00 UTC) with `--strategy standard` (can be run with `low` or `high` manually or scheduled differently).

This script allows AI citizens who run businesses (`RunBy`) to automatically adjust the `Wages` offered for jobs in those business buildings, based on a specified strategy. This complements the KinOS AI-driven `adjustwages.py`.

#### Process:

1.  **AI Operator Identification**: The script identifies AI citizens (`IsAI=true`, `InVenice=true`).
2.  **Business Identification**: For each AI citizen, it retrieves all buildings where they are the `RunBy` and the building `Category` is 'business'.
3.  **Wage Calculation (`calculate_new_wage` function)**: For each business building run by the AI:
    *   **Business Financials**: Considers the building's `Income` and `RentPrice` (if the AI operator doesn't own the building, rent is a cost).
    *   **Market Wage Analysis**: Calculates the average `Wages` of similar business types in the same `District`.
    *   **Profitability**: Estimates profit before wages (`Income` - `RentCost`). A target wage is derived as a percentage of this profit.
    *   **Base Wage**: Blends the profit-based target wage with the market average wage.
    *   **Occupancy & Social Class Factor**:
        *   The `jobRole.socialClass` from the building type definition sets an expected wage.
        *   If the building `Occupant` field is filled (job is taken), the base wage is slightly adjusted towards the wage expectation of the current occupant's `SocialClass`.
        *   If the `Occupant` field is empty (job is vacant), the base wage is more strongly influenced by the building's expected worker `SocialClass` to attract suitable candidates. A minimum attractive wage (e.g., 25 Ducats) is set if the calculated wage for an unoccupied position is too low.
    *   **Strategy Application**: The `--strategy` argument (`low`, `standard`, `high`) applies a multiplier (e.g., 0.85 for low, 1.0 for standard, 1.15 for high) to the base wage.
    *   **Sanity Checks & Rounding**: Ensures wages are not excessively high relative to business profit (unless 'high' strategy) and rounds to the nearest 5 Ducats.
4.  **Update and Notify**:
    *   If the calculated `new_wage` is significantly different from the current `Wages`, the building's `Wages` field is updated.
    *   If an `Occupant` exists (worker in the job), they are notified of the wage change.
    *   A summary notification of all wage adjustments is sent to `ConsiglioDeiDieci`.

#### Command-line Arguments:
*   `--strategy [low|standard|high]`: (Default: `standard`) Defines the wage-setting strategy.
    *   `low`: Aims for lower wages, potentially to save costs if profitability is low.
    *   `standard`: Aims for a balanced wage based on profitability, market, and worker expectations.
    *   `high`: Aims for higher wages, potentially to attract workers quickly or reward productive employees, even if it slightly impacts profits.
*   `--dry-run`: Simulates the process without making changes.

#### Economic Impact:

-   Provides a rule-driven mechanism for AI business operators to manage wages.
-   Aligns wages with business performance, market rates, and the social class expectations of jobs.
-   Responds to job vacancy by potentially adjusting wages to attract workers.
-   Creates a more dynamic labor market.
-   The strategy parameter allows for simulating different employer behaviors.

### Automated Resource Import Management (Rule-Based)

**Implementation**: `backend/ais/automated_adjustimports.py`  
**Schedule**: Daily at 5:00 AM UTC

This script provides a rule-based mechanism for AI citizens to automatically create import contracts, complementing the KinOS AI-driven `adjustimports.py`.

#### Process:

1.  The script identifies all citizens marked as `IsAI=true` and `InVenice=true`.
2.  It fetches definitions for building types (to know which buildings `canImport` and what they `store`) and resource types (to get `importPrice`).
3.  For each AI citizen:
    a.  It retrieves all buildings `RunBy` that citizen.
    b.  It filters these buildings to keep only those whose type definition indicates they `canImport`.
    c.  For each such import-capable building:
        i.  It identifies all resource types the building `stores` according to its type definition.
        ii. For each storable resource:
            1.  It checks if an active import contract already exists for this AI, this building, and this resource. The check uses a deterministic `ContractId` (format: `contract-import-{BUILDING_ID}-{RESOURCE_TYPE}`).
            2.  If no such active contract exists, a new import contract is created.
                *   `Buyer`: The AI citizen.
                *   `BuyerBuilding`: The current building being processed.
                *   `ResourceType`: The storable resource.
                *   `TargetAmount`: Fixed at 10 units.
                *   `PricePerResource`: Set to the `importPrice` of the resource.
                *   `ContractId`: The deterministic ID mentioned above.
                *   `Type`: "import".
                *   `Seller`, `SellerBuilding`, `Transporter`: Left empty, to be filled by `createimportactivities.py`.
                *   `EndAt`: Set to 1 week from creation.
This script does not exclude Nobili, as owning a building that `canImport` and being `RunBy` it is a form of high-level economic management they might engage in, distinct from day-to-day shopkeeping.

#### Economic Impact:

The automated rule-based import system:
-   Ensures that AI-run businesses that can import resources will attempt to stock all their storable goods via basic import contracts if none already exist.
-   Provides a baseline level of import activity for AI citizens, ensuring a minimum supply flow even if the KinOS AI (in `adjustimports.py`) doesn't prioritize certain resources.
-   Acts as a fallback or foundational layer for AI import needs.
-   Contributes to the overall demand for imported goods and the activity of merchant galleys.

### Automated Public Sales and Price Management (Rule-Based)

**Implementation**: `backend/ais/automated_managepublicsalesandprices.py`  
**Schedule**: Daily at 4:00 AM UTC with `--strategy standard` (can be run with `low` or `high` manually or scheduled differently).

This script allows AI citizens (excluding `Nobili`) to automatically create and update `public_sell` contracts for resources their businesses (where they are `RunBy`) can sell. Prices are determined by applying a markup to the resource's `importPrice` based on the chosen strategy. This complements the KinOS AI-driven `managepublicsalesandprices.py`. `Nobili` do not participate in this automated sales management for any businesses they might technically operate.

### Automated Public Storage Contract Management (Rule-Based)

**Implementation**: `backend/ais/automated_adjustpublicstoragecontracts.py`
**Schedule**: Daily (heure à vérifier dans `startup.sh`, typiquement une fois par jour)

Ce script crée ou met à jour les contrats `public_storage` pour les bâtiments de stockage gérés par l'IA.
Pour chaque ressource stockable dans de tels bâtiments, il crée/met à jour un contrat offrant une capacité de stockage.
Le prix (`PricePerResource`) est calculé comme un pourcentage de l'`importPrice` de la ressource. Ce pourcentage est déterminé par des niveaux de prix (ex: "low" 1%, "standard" 2%, "high" 3%) qui peuvent être spécifiés via l'argument `--pricing` du script (par défaut "standard"). Ce prix est interprété comme un coût journalier par unité de capacité.
La durée du contrat est généralement fixée à 1 semaine.
Le `ContractId` est déterministe (`public_storage_{BuildingId}_{ResourceType}`), assurant qu'il n'y a qu'une seule offre de stockage publique par ressource et par bâtiment de stockage, dont le prix reflète le dernier niveau de tarification appliqué par le script.

#### Process:

1.  **Citizen Identification**: Identifies AI citizens (`IsAI=true`, `InVenice=true`).
2.  **Business Identification**: For each AI, retrieves business buildings they `RunBy` (`Category`='business').
3.  **Sellable Resources**: For each business building:
    *   Determines which resources can be sold based on the building type's `productionInformation` (either from a `sells` list or as `outputs` of `Arti` recipes).
4.  **Contract Creation/Update**: For each sellable resource:
    *   Fetches the resource's `importPrice`.
    *   If `importPrice` is valid (positive):
        *   Calculates `PricePerResource` using a strategy-based markup:
            *   `low`: `importPrice * 1.15`
            *   `standard`: `importPrice * 1.30`
            *   `high`: `importPrice * 1.50`
        *   Le `TargetAmount` initial pour un nouveau contrat `public_sell` est mis à `0.0`. Le script `automated_managepublicsalesandprices.py` met à jour le prix et la date de fin, mais ne gère pas activement le stock (`TargetAmount`) du contrat. La gestion du stock (décrémentation lors des ventes, réapprovisionnement) est gérée par d'autres processus ou doit être manuellement/automatiquement ajustée par le vendeur.
        *   Uses a deterministic `ContractId` (format: `contract-public-sell-{SELLER_USERNAME}-{SELLER_BUILDING_ID}-{RESOURCE_TYPE}`) to either create a new `public_sell` contract or update an existing one.
        *   The contract duration is set to 47 hours.
        *   Note: Si `TargetAmount` est initialisé à 0.0 par ce script, aucune vente ne pourra être effectuée via ce contrat tant que le montant ne sera pas mis à jour (par exemple, par le script `managepublicsalesandprices.py` piloté par KinOS, ou manuellement).
5.  **Notification**: An admin summary notification is created.

#### Command-line Arguments:
*   `--strategy [low|standard|high]`: (Default: `standard`) Defines the pricing markup strategy.
*   `--dry-run`: Simulates the process without making changes.

### Automated Lease Price Adjustments (Rule-Based)

**Implementation**: `backend/ais/automated_adjustleases.py`
**Schedule**: Daily at 9:30 PM UTC (21:30 Venice Time) with `--strategy standard`.

Ce script permet aux citoyens IA propriétaires de terrains d'ajuster automatiquement le `LeasePrice` pour les bâtiments situés sur leurs terrains, en fonction d'une stratégie spécifiée.

#### Processus :

1.  **Identification des Propriétaires Fonciers IA**: Le script identifie les citoyens IA (`IsAI=true`, `InVenice=true`) qui possèdent des terrains (`LANDS.Owner`).
2.  **Identification des Bâtiments sur les Terrains**: Pour chaque terrain appartenant à une IA, il récupère tous les bâtiments (`BUILDINGS`) situés sur ce `LandId`.
3.  **Calcul du Nouveau `LeasePrice` (`calculate_new_lease_price` function)**: Pour chaque bâtiment sur un terrain appartenant à une IA (et dont le propriétaire du bâtiment n'est pas l'IA elle-même) :
    *   **Analyse du Marché des Loyers Fonciers**:
        *   Calcule le `LeasePrice` médian global pour des bâtiments de type similaire.
        *   Calcule le `LeasePrice` médian local pour les bâtiments sur le même `LandId`.
    *   **Cible Basée sur le `RentPrice` du Bâtiment**:
        *   Si le `RentPrice` du bâtiment (loyer que le propriétaire du bâtiment facture) est positif, le `LeasePrice` cible est un pourcentage de ce `RentPrice` (ex: 15% pour `low`, 25% pour `standard`, 35% pour `high`).
    *   **Combinaison des Facteurs**: Un prix de base est calculé en pondérant les médianes du marché et la cible basée sur le `RentPrice`.
    *   **Application de la Stratégie**: L'argument `--strategy` (`low`, `standard`, `high`) applique un multiplicateur (ex: 0.90, 1.0, 1.10) au prix combiné.
    *   **Vérifications et Arrondi**:
        *   Le `LeasePrice` ne doit généralement pas dépasser 50% du `RentPrice` du bâtiment.
        *   Une limite de changement de 5% par rapport au `LeasePrice` actuel est appliquée si celui-ci est positif.
        *   Le prix est arrondi (ex: au plus proche de 5 Ducats) et ne peut être négatif.
4.  **Mise à Jour et Notification**:
    *   Si le `new_lease_price` calculé est significativement différent du `LeasePrice` actuel, le champ `LeasePrice` du bâtiment est mis à jour.
    *   Le propriétaire du bâtiment (`BUILDINGS.Owner`) est notifié du changement.
    *   Une notification de résumé de tous les ajustements est envoyée à `ConsiglioDeiDieci`.

#### Arguments en Ligne de Commande :
*   `--strategy [low|standard|high]`: (Défaut: `standard`) Définit la stratégie d'ajustement des prix de location foncière.
*   `--dry-run`: Simule le processus sans effectuer de modifications.

#### Impact Économique :

-   Fournit un mécanisme basé sur des règles pour que les propriétaires fonciers IA gèrent les `LeasePrice`.
-   Aligne les `LeasePrice` avec la rentabilité potentielle des bâtiments (via `RentPrice`) et les conditions du marché.
-   Crée des marchés fonciers plus dynamiques.
-   Le paramètre de stratégie permet de simuler différents comportements de propriétaires fonciers ou phases de marché.

#### Economic Impact:

-   Ensures AI-run businesses consistently offer their products for public sale.
-   Provides a baseline pricing mechanism for AI-sold goods, linked to import costs.
-   Creates a more active and predictable market for resources sold by AIs.
-   The strategy parameter allows for simulating different market conditions or AI seller aggressiveness.

### Public Sell and Price Management (Uses KinOS Engine API)

**Implementation**: `backend/ais/managepublicsalesandprices.py`  
**Schedule**: Daily at 3:00 AM UTC

AI citizens (excluding `Nobili`) strategically create and manage public sell contracts for businesses they operate, including setting prices for resources they sell to other players. This consolidated script uses the KinOS Engine API (via la fonction `send_sales_and_price_strategy_request`). `Nobili` do not use this system for businesses they might technically operate.

#### Process:

1.  The script identifies AI citizens (Nobili or Cittadini) who run buildings capable of selling resources.
2.  For each AI, it gathers comprehensive data:
    *   Their buildings, focusing on those that can sell resources.
    *   Details of resources these buildings can sell, including current prices set by the AI for these resources in these specific buildings.
    *   Market data: import prices, global average sell prices, and average sell prices on the same land parcel for each sellable resource.
    *   The AI's current resource stockpiles.
    *   The AI's existing active public sell contracts.
    *   Recent relevancies and problems affecting the AI, which might influence their strategy.
3.  This ledger is sent to the KinOS Engine API. The AI is prompted to:
    *   Decide which resources to actively sell from each of their sellable buildings.
    *   For each such resource, set a `price_per_resource` and an `target_amount`.
    *   Decide which of their existing public sell contracts should be ended.
    *   Provide reasoning for these decisions.
4.  Based on the AI's response:
    *   New public sell contracts are created, or existing ones are updated with the new price and `TargetAmount`. These contracts typically have a 47-hour duration. A deterministic `ContractId` (based on seller, building, and resource type) is used to manage these contracts, ensuring one active public sell offer per resource, per building, by that AI.
    *   Specified existing contracts are ended by setting their `EndAt` timestamp to the current time.
5.  An admin notification is created summarizing all contract creations, updates, and terminations made by each AI.

AI-run businesses, comme celles gérées par des joueurs, peuvent également **acheter** des ressources via des contrats `public_sell` si nécessaire pour leur production, en utilisant la [logique de sélection de contrat décrite ici](contracts.md#public_sell-contract-mechanics).

#### Economic Impact:

The consolidated AI public sell and price management system:
-   Creates a dynamic marketplace with AI sellers actively managing their offerings and prices.
-   Establishes realistic contract prices influenced by import costs, global averages, local competition, and AI strategic reasoning.
-   Ensures players can find resources for sale, with prices that respond to simulated market understanding by AIs.
-   Provides robust competition and clear price signals in the resource contract.
-   Simulates merchant activity, including pricing strategies, crucial to Venice's economy.
-   Allows AI citizens to adapt their pricing and sales strategy based on their own economic situation (e.g., problems, relevancies).

### Initiation d'Activités et d'Actions Stratégiques par l'IA (via `POST /api/activities/try-create`)

Pour initier toute forme d'entreprise, qu'il s'agisse d'une activité de routine (comme `rest` ou `production`) ou d'une action stratégique (comme `bid_on_land` ou `send_message`), les IA utilisent un endpoint unifié : `POST /api/activities/try-create`.

L'IA (généralement via `autonomouslyRun.py`) formule une `activityType` (qui peut maintenant être une action comme `bid_on_land`) et des `activityParameters` (ex: `{ "landId": "polygon-123", "bidAmount": 5000 }` pour une enchère).
Cet endpoint Next.js transmet la requête au moteur Python. Le moteur Python :
1.  Évalue la faisabilité de l'`activityType` demandé.
2.  Crée un ou plusieurs enregistrements dans la table `ACTIVITIES`. Par exemple, un `activityType: "bid_on_land"` pourrait d'abord créer une activité `goto_citizen` pour se rendre auprès du vendeur.
3.  Le script `processActivities.py` prendra ensuite en charge ces activités. Le processeur de l'activité `goto_citizen` (une fois complétée) pourrait alors déclencher la logique pour effectivement placer l'enchère.

Ce modèle unifié permet des comportements IA plus riches et des processus en plusieurs étapes, tout en simplifiant l'interface de décision pour l'IA.

### AI Thought Generation (Uses KinOS Engine API)

**Implementation**: `backend/ais/generatethoughts.py`  
**Schedule**: Daily at 7:00 AM Venice Time

AI citizens (excluding those of 'Facchini' social class) periodically generate strategic thoughts, providing insight into their decision-making process and adding a layer of depth to their behavior. These thoughts serve a dual purpose: they allow the AIs to "think" strategically about their situation and goals, and the concise selected thought is displayed on the map for players to see, offering clues or context about AI actions.

#### Process:

1.  The script identifies AI citizens (`IsAI=true`, `InVenice=true`).
2.  For each AI citizen, it gathers contextual data by calling various Next.js API endpoints:
    *   The AI's own profile (`/api/citizens/{username}`).
    *   Recent notifications for the AI (`/api/notifications`).
    *   General relevancies concerning the AI (`/api/relevancies`).
    *   Active problems the AI is facing (`/api/problems`).
3.  This contextual data is packaged into an `addSystem` field.
4.  A detailed prompt is sent to the KinOS Engine API (`/v2/blueprints/serenissima-ai/kins/{CitizenUsername}/channels/thoughts/messages`). The prompt instructs the KinOS AI to:
    *   First, generate a paragraph of diverse thoughts based on the provided context. This includes reflecting on strategic goals, economic evaluations, relationship-driven economic thoughts, needs-driven actions (linked to problems), and activity-related intentions.
    *   Second, select ONE single, concise thought (a single sentence) from the paragraph that represents its most pressing or actionable idea.
    *   Enclose this chosen thought within `<thought></thought>` tags.
5.  The script retrieves the KinOS AI's response and extracts the single thought from the `<thought></thought>` tags.
6.  If a thought is successfully extracted and not in `dry-run` mode, a message is created in the `MESSAGES` table in Airtable. This message is from the AI citizen to themselves, with the `Content` being the extracted thought and `Type` set to `thought_log`.
7.  An admin notification is created in Airtable summarizing the thought generation process for all processed AIs, including counts of successes and failures.

#### Impact:

-   **Strategic Depth for AIs**: Provides a mechanism for AIs to perform high-level strategic reasoning based on their current situation, goals, and personality.
-   **Player Insight & Immersion**: Displays AI thoughts on the game map, offering players a window into what AIs are considering. This can make AIs feel more alive and their actions more understandable or predictable.
-   **Dynamic World**: AI thoughts can reflect changing game conditions, relationships, and economic pressures, contributing to a more dynamic and responsive world.
-   **Gameplay Cues**: Player-visible thoughts can act as subtle gameplay cues, hinting at potential AI actions, market shifts, or opportunities for interaction.

#### Detailed Workflow and Key Functions:

The `managepublicsalesandprices.py` script orchestrates the AI's public sales and pricing strategy through several key steps and functions:

1.  **Initialization (`process_ai_sales_and_price_strategies` function):**
    *   Connects to Airtable using `initialize_airtable()`.
    *   Fetches global definitions:
        *   Building types/definitions via `get_building_types_from_api()`.
        *   Resource type definitions via `get_resource_types_from_api()`.
    *   Fetches global market data:
        *   All building records via `get_all_buildings()` (used for mapping BuildingIds to LandIds for localized price analysis).
        *   All currently active public sell contracts from all sellers via `get_all_active_public_sell_contracts()` (used for global price analysis).
    *   Retrieves a list of AI citizens using `get_ai_citizens()`.

2.  **Per-AI Citizen Processing Loop (`process_ai_sales_and_price_strategies`):**
    For each AI citizen identified:
    *   **Data Gathering for the AI:**
        *   `get_citizen_buildings()`: Fetches buildings run by this specific AI.
        *   `get_citizen_resources()`: Fetches all resources currently owned by this AI.
        *   `get_citizen_active_contracts()`: Fetches this AI's existing active public sell contracts.
    *   **Data Preparation (`prepare_sales_and_price_strategy_data` function):** This crucial function assembles a comprehensive ledger for the KinOS AI. It includes:
        *   The AI's basic information (username, ducats).
        *   A list of the AI's buildings that can sell resources (`sellable_buildings_with_market_data`). Each building entry details:
            *   The resources it can sell.
            *   For each sellable resource: its import price, the AI's current selling price in that building, the global average selling price, and the average selling price on the same land parcel.
        *   A summary of all resources owned by the AI (`citizen_owned_resources_summary`).
        *   A list of the AI's current active public sell contracts (`existing_ai_public_sell_contracts`), including their `contract_id`, resource type, price, and quantity.
        *   The AI's latest relevancies (fetched via `get_citizen_relevancies_from_api()`) and active problems (fetched via `get_citizen_problems_from_api()`), providing context for strategic decisions.
    *   **AI Decision Making (`send_sales_and_price_strategy_request` function):**
        *   If the AI has sellable buildings, the prepared ledger is sent to the KinOS Engine API.
        *   A detailed prompt instructs the AI to analyze the data and decide on:
            *   `contracts_to_create_or_update`: A list of resources to sell, specifying the `building_id`, `resource_type`, desired `price_per_resource`, `target_amount`, and `reasoning`.
            *   `contracts_to_end`: A list of existing `contract_id`s to terminate, along with a `reason`.
        *   The function parses the AI's JSON response.
    *   **Executing AI Decisions (within `process_ai_sales_and_price_strategies`):**
        *   If decisions are received from the AI (and not in `dry_run` mode):
            *   **Create/Update Contracts:** Each item in `contracts_to_create_or_update` is validated by `validate_create_or_update_contract_decision()`. If valid, `create_or_update_public_sell_contract_from_decision()` is called. This function:
                *   Generates a deterministic `ContractId` (format: `contract-public-sell-{SELLER_USERNAME}-{SELLER_BUILDING_ID}-{RESOURCE_TYPE}`). This ensures only one active public sell contract exists per resource, per building, for that AI.
                *   If a contract with this ID exists, it's updated (price, quantity, end date).
                *   Otherwise, a new contract is created with a 47-hour duration.
            *   **End Contracts:** Each item in `contracts_to_end` is validated by `validate_end_contract_decision()`. If valid, `end_public_sell_contract()` is called, which sets the `EndAt` field of the specified contract to the current time, effectively terminating it.
    *   **Result Tracking:** The outcomes (contracts created/updated/ended) for each AI are tracked.

3.  **Admin Notification (`create_admin_notification` function):**
    *   After processing all AIs, if any actions were taken (and not in `dry_run`), a summary notification is sent to `ConsiglioDeiDieci`. This message details the number of contracts managed by each AI and lists the specifics of created/updated and ended contracts.

This workflow allows AI citizens to dynamically manage their public sales, adjusting prices and offerings based on market conditions, their own inventory, and strategic considerations derived from their problems and relevancies.

## AI Citizen Management

AI citizens are created and managed through the Airtable database:

### Business Delegation
**Implementation**: `backend/ais/delegateBusinesses.py`  
**Schedule**: (To be determined, e.g., Daily at a specific time)

To prevent AI citizens from becoming overly dominant or complex to manage by accumulating too many businesses, this script redistributes businesses if an AI runs more than a set limit (e.g., 10).

#### Process:
1.  The script identifies AI citizens running more than the `BUSINESS_LIMIT_PER_AI` (e.g., 10) businesses (where `Category` is "business" and the AI is the `RunBy`).
2.  For each "overburdened" AI, businesses beyond the limit are identified for delegation. These are sorted by their `Wages` field in ascending order (lowest wage businesses are delegated first).
3.  The script identifies all other AI citizens as potential "delegatees", sorting them by their `Ducats` balance in descending order (wealthier AIs are prioritized to take over businesses).
4.  Businesses are delegated one by one. The wealthiest available delegatee AI who is currently running fewer than `BUSINESS_LIMIT_PER_AI` businesses takes over the lowest-wage business from an overburdened AI.
5.  The `RunBy` field of the delegated business is updated in the `BUILDINGS` table.
6.  Notifications are sent to the original AI owner, the new AI owner, and an admin summary is created for `ConsiglioDeiDieci`.

#### Economic Impact:
-   Prevents monopolies and encourages a more distributed management of businesses among AI citizens.
-   Ensures that AI business management remains somewhat balanced.
-   Simulates a form of economic regulation or natural churn in business ownership.

### AI Citizen Management (Continued)

AI citizens are created and managed through the Airtable database:

1. Citizens with the `IsAI` flag set to true are treated as AI citizens by the system
2. AI citizens receive compute tokens through the same distribution mechanisms as human players
3. They can own lands, buildings, and other assets
4. Their economic activities generate notifications and transaction records just like human players
5. They participate in the same activity system, with activities like rest, work, and travel
6. Human players can interact with AI citizens through the messaging system, receiving contextually appropriate responses

### Human-AI Interaction

The integration of AI citizens with human players creates a living, breathing Venice:

1. **Economic Interaction**: Human players can buy lands from AI citizens, rent buildings from them, or sell resources to them
2. **Social Interaction**: Human players can send messages to AI citizens and receive contextually appropriate responses
3. **Visual Interaction**: Both AI and human citizens appear on the map, creating a populated city
4. **Competitive Interaction**: AI citizens provide contract competition, ensuring dynamic pricing and land valuation
5. **Collaborative Interaction**: AI citizens can work in businesses owned by human players, contributing to the economy

## Technical Implementation

The AI system is implemented as a series of Python scripts that run on scheduled intervals. Each script:

1. Connects to the Airtable database
2. Identifies AI citizens and relevant economic opportunities
3. Makes decisions based on programmed economic behaviors
4. Updates the database with new transactions, bids, or other changes
5. Creates notifications to inform administrators and affected players

The scripts use the same underlying APIs and database access methods as the rest of the game engine, ensuring consistency in how economic activities are processed. AI agents can leverage the enhanced flexibility of these APIs, such as dynamic filtering on GET requests and flexible key casing on POST requests, to make more informed and precise decisions.

## Future AI Behaviors

The AI system is designed to be extensible, allowing for additional behaviors to be added over time:

1. **Business Operation**: AI citizens could operate businesses and hire citizens
2. **Contract Trading**: AI citizens could buy and sell resources on the open contract
3. **Banking Activities**: AI citizens could offer loans or banking services

Each new behavior would be implemented as a separate script following the same pattern as the existing AI systems.

## Monitoring and Administration

Administrators can monitor AI activity through:

1. Notifications generated by AI actions
2. Transaction records showing AI economic activity
3. The Airtable database, which stores all AI citizen data and actions

If needed, administrators can adjust AI behavior by:
1. Modifying the parameters in the AI scripts (e.g., bid multipliers, frequency of actions)
2. Adding or removing the `IsAI` flag from specific citizens
3. Manually intervening in specific transactions or bids

## Conclusion

The AI system creates a more vibrant and realistic economy in La Serenissima by simulating the behavior of non-player economic actors. This ensures that the game world remains dynamic and economically active even in areas with limited player participation, while providing meaningful competition and interaction for human players.
